根据提供的文档，以下是关于如何计算ANSI/IES TM-30-20标准中**保真度指数 (Rf)** 和**色域指数 (Rg)** 的方法的分析。这些指数是TM-30方法的核心输出，用于评估光源的颜色还原性能。以下内容基于文档中相关章节的描述，特别是第4节（TM-30计算框架）和第5节（TM-30措施及其意义）。

---

### **1. 保真度指数 (Rf) 的计算方法**

**定义**：
- **保真度指数 (Rf)** 是一个度量，用于表征光源与参考光源相比的平均色彩保真度，表示光源如何准确地再现99个颜色评估样本（CES）的颜色。它是TM-30的核心输出之一，范围从0到100，值越高表示与参考光源的颜色匹配度越高。
- **Rf** 旨在取代CIE的通用显色指数（CRI，Ra），通过改进颜色空间和样本数量，提供更准确的色彩保真度评估。

**计算框架**（参考第4节和第5.3节）：
1. **核心组件**：
   - **颜色匹配函数**：使用CIE 1964 10°色彩匹配函数来计算颜色坐标。
   - **颜色空间**：采用CAM02-UCS颜色空间，因其比CIE U*V*W*（1960）或CIE LAB（1976）更均匀，映射人类对色差的感知更准确。
   - **颜色评估样本 (CES)**：使用99个代表真实物体光谱反射函数的颜色样本，这些样本是从超过10万个光谱反射率测量中精选出的，均匀覆盖颜色空间。
   - **参考光源**：根据测试光源的相关色温（CCT）选择参考光源：
     - CCT ≤ 4000 K：普朗克辐射体（黑体辐射）。
     - CCT ≥ 5000 K：CIE D系列光源。
     - 4000 K < CCT < 5000 K：普朗克辐射体与CIE D系列光源的比例混合。
   - **光谱功率分布 (SPD)**：测试光源和参考光源的SPD用于计算颜色差异。

2. **计算步骤**：
   - **颜色坐标计算**：对99个CES，分别在测试光源和参考光源下计算其在CAM02-UCS颜色空间中的颜色坐标（a, b, J）。
   - **颜色差异计算**：计算每个CES在测试光源和参考光源下颜色坐标的差异（色差），通常以色差公式（如ΔE）为基础。
   - **平均色差**：将99个CES的色差值进行平均，得到平均色差。
   - **变换与缩放**：
     - 对平均色差应用比例因子（以标准化输出）。
     - 使用对数变换防止负值，确保Rf值在0到100之间。
     - 最终公式为：**Rf = 100 - k × 平均色差**，其中k为比例因子，具体值在ANSI/IES TM-30-20标准中有详细定义。
   - **输出**：Rf值从0到100，100表示测试光源与参考光源完全匹配，值越低表示颜色差异越大。

3. **注意事项**：
   - Rf并非99个独立保真度值（Rces）的简单平均值，因为每个保真度值经过变换以避免负值。
   - Rf的局限性在于它是一个平均值，无法反映特定色调的色差方向或大小（见第5.3节）。例如，某些色调可能向一个方向偏移，而其他色调可能向相反方向偏移，但如果平均色差幅度相同，Rf值将相同。
   - 在建筑室内照明中，Rf低于60通常被认为不适合（见第5.3节）。

**与CRI的区别**（参考第5.4节）：
- **颜色空间**：CRI使用CIE U*V*W*（1960），而Rf使用更均匀的CAM02-UCS，减少了系统偏差。
- **样本数量**：CRI仅使用8个柔和的Munsell颜色样本，Rf使用99个更具代表性的CES，覆盖更广的颜色范围。
- **准确性**：CRI因样本数量少和颜色空间不均匀，导致值不精确且有偏差，Rf通过改进这些方面提供更可靠的保真度测量。
- **偏差**：CRI对增加红色的色度变化更敏感（导致值降低更多），而Rf在CAM02-UCS中更公平地评估色差。

---

### **2. 色域指数 (Rg) 的计算方法**

**定义**：
- **色域指数 (Rg)** 是一个度量，用于表征光源相对于参考光源的色域面积，表示所有色调的平均色度变化（见第5.5节）。它反映了光源如何影响颜色的饱和度（色度），值大于100表示色度增强，小于100表示色度减弱。
- Rg与Rf互补，提供关于颜色鲜艳度的信息，而不仅仅是保真度。

**计算框架**（参考第4.4节和第5.5节）：
1. **核心组件**：
   - 与Rf相同，使用CIE 1964 10°色彩匹配函数、CAM02-UCS颜色空间、99个CES和基于CCT的参考光源。
   - 额外需要将99个CES分配到16个色调角箱（hue angle bins），每个箱覆盖22.5°的CAM02-UCS (a, b)平面，用于分析特定色调区域的色度变化（见第4.4节）。

2. **计算步骤**：
   - **颜色样本分配**：根据参考光源下每个CES的颜色坐标，将其分配到16个色调角箱之一（每个箱包含2到11个样本，具体数量因CCT而异）。
   - **色度坐标计算**：对每个色调角箱，计算测试光源和参考光源下样本的平均(a, b)坐标。
   - **色域面积计算**：
     - 在CAM02-UCS的(a, b)平面上，基于16个色调角箱的平均坐标，绘制测试光源和参考光源的色域形状。
     - 计算测试光源的色域面积（由连接16个箱的平均坐标点形成的形状）。
     - 计算参考光源的色域面积（通常为标准化圆形）。
   - **Rg计算**：Rg是测试光源色域面积与参考光源色域面积的比率，乘以100：
     - **Rg = (测试光源色域面积 / 参考光源色域面积) × 100**。
   - **输出**：Rg值通常在70到130之间：
     - Rg > 100：测试光源增强了色度（颜色更鲜艳）。
     - Rg < 100：测试光源降低了色度（颜色更暗淡）。
     - Rg = 100：测试光源与参考光源的色域面积相同。

3. **注意事项**：
   - Rg是平均色度变化的近似值，不直接反映色调偏移（hue shift）。色调偏移通过颜色矢量图形（CVG）或其他局部度量（如局部色度偏移Rcs,hj）来分析（见第5.6节和第5.7节）。
   - Rg值与色域形状相关，形状通过颜色矢量图形可视化，显示哪些色调的色度增加或减少。
   - Rg对某些应用（如需要鲜艳颜色的场景）至关重要，但不能单独决定光源的适用性，因为它不反映保真度或特定色调的表现。

---

### **关键特点与应用**：
1. **Rf与Rg的互补性**：
   - Rf关注颜色与参考光源的匹配程度（保真度），而Rg关注颜色饱和度的变化（色域面积）。
   - 两者结合使用可以更全面地描述光源的颜色还原性能。例如，高Rf值可能表示颜色准确，但如果Rg值较低，颜色可能显得暗淡；反之，高Rg值可能表示鲜艳的颜色，但如果Rf值较低，可能存在较大的色差。

2. **实际应用**（参考第2.9节）：
   - **生产商**：使用Rf和Rg设计和优化光源。
   - **规范制定者**：利用Rf和Rg建立显色性能标准，确保光源满足特定应用需求。
   - **研究人员**：通过Rf和Rg进行视觉评估实验，探索颜色质量的影响。
   - **照明设计师**：根据Rf和Rg选择适合特定环境（如零售、办公室）的光源。

3. **局限性**：
   - **Rf**：平均值掩盖了特定色调的表现，需结合局部色度偏移（Rcs,hj）或颜色矢量图形进一步分析。
   - **Rg**：仅反映平均色域面积，无法直接量化色调偏移或特定色调的色度变化。
   - 两者均基于标准化的99个CES，可能无法完全代表特定场景中的物体颜色。

4. **与颜色矢量图形的关联**（参考第5.6节）：
   - 颜色矢量图形（CVG）是Rg的视觉补充，显示16个色调角箱中测试光源相对于参考光源的色度变化方向和幅度。
   - CVG通过箭头和红线形状直观展示色域形状，帮助用户理解Rg值的来源（例如，哪些色调的色度增强或减弱）。

---

### **总结**：
- **Rf计算**：通过比较99个CES在测试光源和参考光源下的颜色坐标差异，计算平均色差，经缩放和对数变换得到0到100的指数，反映颜色保真度。
- **Rg计算**：通过将99个CES分配到16个色调角箱，计算测试光源和参考光源的色域面积比率，反映平均色度变化。
- **共同点**：两者均基于CAM02-UCS颜色空间、99个CES和基于CCT的参考光源，提供更科学的颜色评估框架。
- **差异**：Rf关注颜色准确性，Rg关注颜色饱和度变化；Rf是单一数值，Rg与颜色矢量图形结合提供更详细的色域形状信息。

如需更详细的计算公式或具体实施步骤，可参考ANSI/IES TM-30-20标准文档（可从IES网站免费下载，参考第4节）。如果需要进一步分析特定输出或应用场景，请提供更多细节，我可以深入探讨！