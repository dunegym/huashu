# 睡眠数据分析建模任务流程框架与算法思路

## 1. 研究背景与目标

**研究问题**: 不同光照环境（助眠灯、普通LED、黑暗）对人体睡眠质量的影响

**实验设计**: 
- 被试内设计（Within-subject design）
- 11个受试者，每人在3种环境下各测试一次
- 数据格式：时间序列的睡眠阶段编码（0.5分钟间隔）

## 2. 数据预处理流程

### 2.1 缺失值处理策略
```
输入: 睡眠阶段编码序列（可能包含NaN）
算法: fill_missing()

处理规则:
├── 首段缺失 → 用下一个有效值填充
├── 末段缺失 → 用前一个有效值填充
└── 中间缺失 
    ├── 短缺失(≤2) → 线性插值
    └── 长缺失(>2) → 用前值填充
```

### 2.2 睡眠阶段编码体系
- 编码1: N1轻睡眠
- 编码2: N2浅睡眠  
- 编码3: N3深睡眠
- 编码4: 清醒状态
- 编码5: REM快眼动睡眠

## 3. 睡眠指标计算算法

### 3.1 核心指标定义
```python
# 基础参数计算
total_bed_time = 序列长度 × 0.5  # 总卧床时间(分钟)
non_awake_indices = [i for i, val in enumerate(sequence) if val != 4]
sleep_onset = non_awake_indices[0]  # 入睡点
sleep_offset = non_awake_indices[-1]  # 末次睡眠点
```

### 3.2 六大睡眠指标算法

#### TST (总睡眠时长)
```
TST = (sleep_offset - sleep_onset + 1) × 0.5 分钟
```

#### SE (睡眠效率)
```
SE = (TST / total_bed_time) × 100%
```

#### SOL (入睡潜伏期)
```
SOL = sleep_onset × 0.5 分钟
```

#### N3p (深睡眠N3比例)
```
N3p = (N3阶段时长 / TST) × 100%
```

#### REMp (REM睡眠比例)
```
REMp = (REM阶段时长 / TST) × 100%
```

#### Awakenings (夜间醒来次数)
```
算法: 扫描sleep_onset到sleep_offset区间
for i in range(sleep_onset+1, sleep_offset+1):
    if sequence[i] == 4 and sequence[i-1] != 4:
        awakening_count += 1
```

## 4. 统计分析框架

### 4.1 数据结构转换
```
宽格式 → 长格式转换:
原始: 每列代表一个受试者×环境组合
目标: Subject_ID | Environment | 各项睡眠指标
```

### 4.2 统计检验流程

#### 步骤1: 正态性检验
```python
# Shapiro-Wilk检验
stat, p_value = shapiro(data)
is_normal = p_value > 0.05
```

#### 步骤2: 主效应检验
```python
if is_normal:
    # 重复测量方差分析
    test = AnovaRM(data=df, depvar=metric, 
                   subject='Subject_ID', 
                   within=['Environment'])
else:
    # Friedman非参数检验
    stat, p_value = friedmanchisquare(data_A, data_B, data_C)
```

#### 步骤3: 事后检验（如果主效应显著）
```python
if p_main < 0.05:
    if is_normal:
        # 配对t检验 + Bonferroni校正
        p_AB = ttest_rel(data_A, data_B).pvalue × 3
        p_AC = ttest_rel(data_A, data_C).pvalue × 3
        p_BC = ttest_rel(data_B, data_C).pvalue × 3
    else:
        # Wilcoxon符号秩检验 + Bonferroni校正
        p_AB = wilcoxon(data_A, data_B).pvalue × 3
        # ...类似处理
```

## 5. 可视化分析策略

### 5.1 多维度可视化方案
```
1. 箱形图 + 散点图 → 显示分布和离群值
2. 小提琴图 → 显示概率密度分布
3. 柱状图 + 误差棒 → 显示均值和变异性
4. 相关性热力图 → 指标间关系
5. 雷达图 → 多指标综合比较
6. 密度分布图 → 各组分布形状比较
```

### 5.2 图表设计原则
- 使用中文标签和标题
- 统一的颜色编码（助眠灯-红色，LED-蓝色，黑暗-绿色）
- 添加数值标注和统计信息
- 高分辨率输出（300 DPI）

## 6. 核心算法思路总结

### 6.1 数据处理思路
```
原始时间序列 → 缺失值处理 → 睡眠指标提取 → 数据结构重组
```

### 6.2 统计分析思路
```
描述性统计 → 正态性检验 → 选择检验方法 → 主效应分析 → 事后比较
```

### 6.3 结果解释策略
- **效应方向判断**: 对于TST、SE、N3p、REMp，数值越大越好
- **反向指标**: 对于SOL、Awakenings，数值越小越好
- **显著性水平**: α = 0.05
- **多重比较校正**: Bonferroni方法

## 7. 技术栈与工具选择

### 7.1 核心库
- **pandas**: 数据处理和结构转换
- **numpy**: 数值计算
- **scipy.stats**: 统计检验
- **statsmodels**: 重复测量ANOVA
- **matplotlib + seaborn**: 可视化

### 7.2 方法学特点
- **被试内设计**: 每个受试者都参与所有条件，控制个体差异
- **重复测量**: 考虑受试者间的相关性
- **稳健性处理**: 正态和非正态数据都有对应方法
- **多重比较校正**: 控制I类错误

## 8. 实际应用价值

### 8.1 临床意义
- 为助眠设备设计提供科学依据
- 评估不同光照环境的睡眠干预效果
- 支持睡眠医学研究

### 8.2 方法学贡献
- 提供完整的睡眠数据分析pipeline
- 展示时间序列睡眠数据的标准化处理流程
- 结合参数和非参数统计方法的综合分析框架

这个建模任务展现了生物医学数据分析的典型特征：数据预处理复杂、指标计算专业化、统计方法需要根据数据特征灵活选择，以及结果解释需要结合领域知识。